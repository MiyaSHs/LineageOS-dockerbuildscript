#!/usr/bin/env bash
set -eo pipefail

PROJECT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
cd "$PROJECT_DIR"

VARIABLES_FILE="$PROJECT_DIR/VARIABLES"

# Load previously saved defaults (if present).
if [[ -f "$VARIABLES_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$VARIABLES_FILE"
fi

# ---- helpers ----

prompt() {
  local var="$1" msg="$2" def="${3-}"
  local cur="${!var-}"
  local show_def="$def"
  [[ -n "$cur" ]] && show_def="$cur"

  if [[ -n "$show_def" ]]; then
    read -r -p "${msg} [${show_def}]: " ans
    ans="${ans:-$show_def}"
  else
    read -r -p "${msg}: " ans
  fi
  printf -v "$var" '%s' "$ans"
}

prompt_nonempty() {
  local var="$1" msg="$2" def="${3-}"
  while :; do
    prompt "$var" "$msg" "$def"
    [[ -n "${!var-}" ]] && break
    echo "Please enter a value."
  done
}

prompt_yesno() {
  local var="$1" msg="$2" def="${3:-true}"
  local cur="${!var-}"
  local d="$def"
  [[ -n "$cur" ]] && d="$cur"

  local suffix="[y/N]"
  [[ "$d" == "true" ]] && suffix="[Y/n]"

  while :; do
    read -r -p "${msg} ${suffix}: " ans
    ans="${ans,,}"
    if [[ -z "$ans" ]]; then
      printf -v "$var" '%s' "$d"
      return 0
    fi
    case "$ans" in
      y|yes) printf -v "$var" 'true'; return 0 ;;
      n|no)  printf -v "$var" 'false'; return 0 ;;
    esac
    echo "Please answer y or n."
  done
}

prompt_choice() {
  local var="$1"; shift
  local -a opts=("$@")
  local cur="${!var-}"

  echo
  for i in "${!opts[@]}"; do
    printf "%d) %s\n" "$((i+1))" "${opts[$i]}"
  done

  local def_idx=""
  if [[ -n "$cur" ]]; then
    for i in "${!opts[@]}"; do
      if [[ "${opts[$i]}" == "$cur" ]]; then
        def_idx="$((i+1))"
        break
      fi
    done
  fi

  while :; do
    if [[ -n "$def_idx" ]]; then
      read -r -p "Choose [1-${#opts[@]}] (Enter = ${def_idx}): " ans
      ans="${ans:-$def_idx}"
    else
      read -r -p "Choose [1-${#opts[@]}]: " ans
    fi

    [[ "$ans" =~ ^[0-9]+$ ]] || { echo "Enter a number."; continue; }
    (( ans >= 1 && ans <= ${#opts[@]} )) || { echo "Out of range."; continue; }

    printf -v "$var" '%s' "${opts[$((ans-1))]}"
    return 0
  done
}

normalize_device_list() {
  local in="$1"
  # turn spaces into commas, collapse repeats, strip leading/trailing commas
  in="${in// /,}"
  in="$(echo "$in" | tr -s ',' )"
  in="${in#,}"
  in="${in%,}"
  echo "$in"
}

save_variables() {
  cat > "$VARIABLES_FILE" <<EOF
# Auto-generated by main
ANDROID_VERSION="${ANDROID_VERSION}"
PARALLEL_JOBS="${PARALLEL_JOBS}"
BRANCH_NAME="${BRANCH_NAME}"
DEVICE_LIST="${DEVICE_LIST}"
BUILD_FLAVOR="${BUILD_FLAVOR}"
ROOT_METHOD="${ROOT_METHOD}"
KERNEL_OPT_PROFILE="${KERNEL_OPT_PROFILE}"
REPLACE_STOCK_FDROID="${REPLACE_STOCK_FDROID}"
SIGN_BUILDS="${SIGN_BUILDS}"
EOF
  echo "Saved config to $VARIABLES_FILE"
}

# ---- main prompts ----
# Important: NO "one-time" prompts. Everything is asked every run,
# but pressing Enter accepts the previous selection from VARIABLES.

prompt_nonempty ANDROID_VERSION "Android version (e.g. 16.0)" "${ANDROID_VERSION:-16.0}"
prompt_nonempty PARALLEL_JOBS "Parallel repo sync/build jobs" "${PARALLEL_JOBS:-6}"

echo
prompt_nonempty BRANCH_NAME "Branch name (e.g. lineage-23.0)" "${BRANCH_NAME:-lineage-23.0}"
prompt_nonempty DEVICE_LIST "Device codename(s), comma-separated" "${DEVICE_LIST:-}"
DEVICE_LIST="$(normalize_device_list "$DEVICE_LIST")"

echo
echo "Build flavor:"
# FIXED: only real options; no duplicates.
prompt_choice BUILD_FLAVOR "base" "microg"

echo
echo "Root method:"
prompt_choice ROOT_METHOD "none" "kernelsu" "kernelsu-next" "sukisu-ultra"

echo
echo "Kernel optimization profile:"
prompt_choice KERNEL_OPT_PROFILE "none" "battery" "balanced" "performance"

echo
prompt_yesno REPLACE_STOCK_FDROID "Replace stock FDroid (when present via partner_gms)?" "${REPLACE_STOCK_FDROID:-false}"

echo
prompt_yesno SIGN_BUILDS "Sign builds (use keys/ folder)?" "${SIGN_BUILDS:-false}"

echo
prompt_yesno SAVE_VARS "Save to VARIABLES?" "true"
if [[ "$SAVE_VARS" == "true" ]]; then
  save_variables
fi

# ---- dispatch ----
case "$BUILD_FLAVOR" in
  base)
    bash "$PROJECT_DIR/buildscripts/build-lineageos-base"
    ;;
  microg)
    bash "$PROJECT_DIR/buildscripts/build-lineageos-microg"
    ;;
  *)
    echo "Unknown build flavor: $BUILD_FLAVOR"
    exit 2
    ;;
esac
