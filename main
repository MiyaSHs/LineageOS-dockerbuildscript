#!/usr/bin/env bash
set -eo pipefail

PROJECT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "$SCRIPT_DIR/VARIABLES" ]]; then
  # auto-export everything from VARIABLES
  set -a
  source "$SCRIPT_DIR/VARIABLES"
  set +a
fi

# Always set/export the payload dir
: "${CUSTOM_APPS_PAYLOAD_DIR:="$SCRIPT_DIR/custom_apps_payload"}"
export CUSTOM_APPS_PAYLOAD_DIR
mkdir -p "$CUSTOM_APPS_PAYLOAD_DIR"

source "$PROJECT_DIR/scripts/bootstrap"
source "$PROJECT_DIR/scripts/ui"
source "$PROJECT_DIR/scripts/modules/customapps"
source "$PROJECT_DIR/scripts/modules/stores"

run_keygen_if_needed() {
  if [[ "${SIGN_BUILDS}" == "true" ]]; then
    echo
    echo "Signing is enabled."
    read -rp "Generate / verify signing keys now? [Y/n]: " ans
    ans="${ans:-Y}"
    if [[ "$ans" =~ ^[Yy]$ ]]; then
      bash "$PROJECT_DIR/scripts/genkeys"
    fi
  fi
}

save_variables() {
  local out="$PROJECT_DIR/VARIABLES"
  {
    echo '# VARIABLES - saved config for LineageOS docker builds'
    echo '# This file is sourced by main/build scripts.'
    echo
    printf 'DEVICE_LIST=%q\n' "$DEVICE_LIST"
    printf 'BRANCH_NAME=%q\n' "$BRANCH_NAME"
    echo
    echo '# microG related: no | restricted | yes'
    printf 'SIGNATURE_SPOOFING=%q\n' "$SIGNATURE_SPOOFING"
    echo
    echo '# true | false'
    printf 'SIGN_BUILDS=%q\n' "$SIGN_BUILDS"
    echo
    echo '# e.g. 50G, 100G, 200G'
    printf 'CCACHE_SIZE=%q\n' "$CCACHE_SIZE"
    echo
    echo '# integer, e.g. 2, 4, 8, 16'
    printf 'PARALLEL_JOBS=%q\n' "$PARALLEL_JOBS"
    echo
    echo '# Kernel optimization: none | battery | balanced | performance'
    printf 'KERNEL_OPT_PROFILE=%q\n' "$KERNEL_OPT_PROFILE"
    echo
    echo '# Store client (system app): none | fdroid | droidify | neostore'
    printf 'STORE_CLIENT=%q\n' "$STORE_CLIENT"
    echo
    echo '# Add Aurora Store as system app: true | false'
    printf 'ADD_AURORA_STORE=%q\n' "$ADD_AURORA_STORE"
    echo
    echo '# Try to remove FDroid + PrivExt from vendor/partner_gms (microG builds only): true | false'
    printf 'REPLACE_STOCK_FDROID=%q\n' "$REPLACE_STOCK_FDROID"
    echo
    echo '# Root integration: none | kernelsu | kernelsu-next | sukisu-ultra'
    printf 'ROOT_METHOD=%q\n' "$ROOT_METHOD"
    echo
    echo '# Optional (ignored if unsupported by container)'
    printf 'ZIP_UP_IMAGES=%q\n' "$ZIP_UP_IMAGES"
    printf 'LOCAL_MIRROR=%q\n' "$LOCAL_MIRROR"
  } > "$out"
  echo "Saved config to $out"
}

main() {
  check_deps

  if [[ ! -f "$PROJECT_DIR/VARIABLES" ]]; then
    echo "First run tips:"
    echo "  DEVICE_LIST  = your device codename (e.g. mondrian)"
    echo "  BRANCH_NAME  = Lineage branch (e.g. lineage-23.0)"
    echo
  fi

  # Ask every run, with previous selection as default
  prompt_nonempty DEVICE_LIST "DEVICE_LIST" "$DEVICE_LIST"
  prompt_nonempty BRANCH_NAME "BRANCH_NAME" "$BRANCH_NAME"

  prompt_choice SIGNATURE_SPOOFING "SIGNATURE_SPOOFING:" "no" "restricted" "yes"
  prompt_choice SIGN_BUILDS "SIGN_BUILDS:" "true" "false"
  run_keygen_if_needed

  prompt_nonempty CCACHE_SIZE "CCACHE_SIZE (e.g. 100G)" "$CCACHE_SIZE"
  prompt_int PARALLEL_JOBS "PARALLEL_JOBS" "$PARALLEL_JOBS"

  prompt_choice KERNEL_OPT_PROFILE "Kernel optimization profile:" \
    "none" "battery" "balanced" "performance"

  prompt_choice BUILD_FLAVOR "Build flavor:" "base" "microg"

  # Store selection
  prompt_choice STORE_CLIENT "Store client (system app):" "none" "fdroid" "droidify" "neostore"
  prompt_choice ADD_AURORA_STORE "Add Aurora Store (system app)?" "false" "true"

  # Only relevant for microG builds (WITH_GMS=true pulls vendor/partner_gms which already includes FDroid)
  if [[ "$BUILD_FLAVOR" == "microg" && "$STORE_CLIENT" != "fdroid" && "$STORE_CLIENT" != "none" ]]; then
    REPLACE_STOCK_FDROID="true"
  else
    REPLACE_STOCK_FDROID="false"
  fi

  # Apply store choices into CUSTOM_APPS, then optionally let user edit/add extras
  stores_apply "$BUILD_FLAVOR"
  custom_apps_prompt

  prompt_choice ROOT_METHOD "Root method:" "none" "kernelsu" "kernelsu-next" "sukisu-ultra"

  save_variables

  export_config
  export ROOT_METHOD

  case "$BUILD_FLAVOR" in
    base)   exec bash "$PROJECT_DIR/buildscripts/build-lineageos-base" ;;
    microg) exec bash "$PROJECT_DIR/buildscripts/build-lineageos-microg" ;;
  esac
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  main "$@"
fi
