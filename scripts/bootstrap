#!/usr/bin/env bash
set -eo pipefail

PROJECT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd)"

# ---- Load config (VARIABLES) if present ----
if [[ -f "$PROJECT_DIR/VARIABLES" ]]; then
  # shellcheck disable=SC1090
  source "$PROJECT_DIR/VARIABLES"
fi

# ---- Defaults (do NOT overwrite existing values) ----
: "${DEVICE_LIST:=}"
: "${BRANCH_NAME:=}"
: "${SIGNATURE_SPOOFING:=restricted}"  # no | restricted | yes
: "${SIGN_BUILDS:=true}"              # true | false
: "${CCACHE_SIZE:=100G}"              # e.g. 50G, 100G
: "${PARALLEL_JOBS:=4}"               # integer
: "${ZIP_UP_IMAGES:=true}"            # true | false
: "${LOCAL_MIRROR:=false}"            # true | false

# Store selection
: "${STORE_CLIENT:=none}"             # none | fdroid | droidify | neostore
: "${ADD_AURORA_STORE:=false}"        # true | false
: "${REPLACE_STOCK_FDROID:=false}"    # true | false (microG only)

# Custom apps
: "${CUSTOM_APPS_FILE:=$PROJECT_DIR/CUSTOM_APPS}"  # one app spec per line
: "${CUSTOM_PACKAGES:=}"                           # space-separated module names

die() { echo "ERROR: $*" >&2; exit 1; }

require_var() {
  local name="$1"
  if [[ -z "${!name:-}" ]]; then
    die "Required variable '$name' is not set"
  fi
}

check_deps() {
  command -v docker >/dev/null 2>&1 || die "docker not found"
  docker info >/dev/null 2>&1 || die "docker daemon not reachable (service running? permissions?)"
}

export_config() {
  export DEVICE_LIST BRANCH_NAME SIGNATURE_SPOOFING SIGN_BUILDS CCACHE_SIZE PARALLEL_JOBS \
         ZIP_UP_IMAGES LOCAL_MIRROR \
         STORE_CLIENT ADD_AURORA_STORE REPLACE_STOCK_FDROID \
         CUSTOM_APPS_FILE CUSTOM_PACKAGES
}
