#!/usr/bin/env bash
set -eo pipefail

# Always prompts at least once.
# - If a default exists, Enter keeps it.
# - Otherwise it keeps asking until non-empty.
prompt_nonempty() {
  local var_name="$1"
  local prompt="$2"
  local explicit_default="${3-}"
  declare -n ref="$var_name"

  # Use explicit default if provided, else current value as default.
  local default="${explicit_default:-${ref-}}"

  while true; do
    if [[ -n "$default" ]]; then
      read -rp "$prompt [$default]: " ref
      ref="${ref:-$default}"
    else
      read -rp "$prompt: " ref
    fi

    [[ -n "${ref}" ]] && return 0
  done
}

# Always prompts; Enter chooses default.
# Default is:
# - current value if it matches an option
# - otherwise option 1
prompt_choice() {
  local var_name="$1"
  local prompt="$2"
  shift 2
  local options=("$@")
  declare -n ref="$var_name"

  local current="${ref-}"
  local default_idx=1

  # If current matches an option, that option becomes default
  local i=1
  for opt in "${options[@]}"; do
    if [[ -n "$current" && "$opt" == "$current" ]]; then
      default_idx="$i"
      break
    fi
    ((i++))
  done

  echo
  echo "$prompt"
  i=1
  for opt in "${options[@]}"; do
    if (( i == default_idx )); then
      echo "  $i) $opt (default)"
    else
      echo "  $i) $opt"
    fi
    ((i++))
  done

  while true; do
    read -rp "Choose [1-${#options[@]}] (Enter = $default_idx): " choice
    if [[ -z "$choice" ]]; then
      ref="${options[$((default_idx-1))]}"
      return 0
    fi

    [[ "$choice" =~ ^[0-9]+$ ]] || continue
    (( choice >= 1 && choice <= ${#options[@]} )) || continue
    ref="${options[$((choice-1))]}"
    return 0
  done
}

# Always prompts at least once; Enter keeps default.
prompt_int() {
  local var_name="$1"
  local prompt="$2"
  local explicit_default="${3-}"
  declare -n ref="$var_name"

  local default="${explicit_default:-${ref-}}"

  while true; do
    if [[ -n "$default" ]]; then
      read -rp "$prompt [$default]: " ref
      ref="${ref:-$default}"
    else
      read -rp "$prompt: " ref
    fi

    [[ "$ref" =~ ^[0-9]+$ ]] && return 0
    echo "Please enter a valid integer."
  done
}
