#!/usr/bin/env bash
set -eo pipefail

# Auto-managed block markers inside CUSTOM_APPS_FILE
_STORES_BEGIN="# --- AUTO:STORES BEGIN ---"
_STORES_END="# --- AUTO:STORES END ---"

stores_apply() {
  local flavor="${1:-base}"  # base | microg

  : "${CUSTOM_APPS_FILE:=$PROJECT_DIR/CUSTOM_APPS}"
  mkdir -p "$(dirname "$CUSTOM_APPS_FILE")"
  touch "$CUSTOM_APPS_FILE"

  local tmp
  tmp="$(mktemp)"

  # Remove any existing auto block
  awk -v b="$_STORES_BEGIN" -v e="$_STORES_END" '
    $0==b {inside=1; next}
    $0==e {inside=0; next}
    !inside {print}
  ' "$CUSTOM_APPS_FILE" > "$tmp"

  # Build new auto block lines
  local lines=()

  # In microg builds, vendor/partner_gms already includes FDroid+PrivExt if WITH_GMS=true.
  # So only add FDroid via custom apps for BASE builds (or if user explicitly chooses it there).
  case "${STORE_CLIENT:-none}" in
    none)
      ;;
    fdroid)
      if [[ "$flavor" == "base" ]]; then
        # NOTE: do NOT name this module "FDroid" to avoid collisions if user later builds microg.
        # We'll call it "FDroidClient".
        lines+=( "fdroid:org.fdroid.fdroid|name=FDroidClient|privileged=false|cert=presigned" )
      fi
      ;;
    droidify)
      # Droid-ify is on F-Droid: com.looker.droidify
      lines+=( "fdroid:com.looker.droidify|name=Droidify|privileged=false|cert=presigned" )
      ;;
    neostore)
      # Neo-Store from GitHub releases
      lines+=( "gh:NeoApplications/Neo-Store|name=NeoStore|asset=.*\\.apk$|privileged=false|cert=presigned" )
      ;;
    *)
      echo "WARN: Unknown STORE_CLIENT='${STORE_CLIENT}'. Skipping."
      ;;
  esac

  if [[ "${ADD_AURORA_STORE:-false}" == "true" ]]; then
    # Aurora Store from F-Droid (avoids GitHub release API 404s)
    lines+=( "fdroid:com.aurora.store|name=AuroraStore|privileged=false|cert=presigned" )
  fi

  # Write back: auto block (if needed) + rest of file
  if (( ${#lines[@]} > 0 )); then
    {
      echo "$_STORES_BEGIN"
      echo "# Auto-generated by main. Do not edit inside this block."
      printf '%s\n' "${lines[@]}"
      echo "$_STORES_END"
      echo
      cat "$tmp"
    } > "$CUSTOM_APPS_FILE"
  else
    # No store apps requested -> just write remaining file
    cat "$tmp" > "$CUSTOM_APPS_FILE"
  fi

  rm -f "$tmp"

  echo
  echo "Store selection applied to $CUSTOM_APPS_FILE"
}
