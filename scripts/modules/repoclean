#!/usr/bin/env bash
set -eo pipefail

# Kernel purge only.
# Purpose: prevent repo sync from failing with:
#   "Cannot remove project: uncommitted changes are present"
# by removing the entire kernel/ directory before repo sync.
#
# Device-independent: does NOT assume sm8450 or any vendor path.
#
# Toggle:
#   KERNEL_PURGE_BEFORE_SYNC=true|false  (default true)
: "${KERNEL_PURGE_BEFORE_SYNC:=true}"

repoclean_kernel_top() {
  local top="$1"
  [[ "$KERNEL_PURGE_BEFORE_SYNC" == "true" ]] || return 0
  [[ -n "$top" && -d "$top/.repo" ]] || return 0
  [[ "$top" != "/" ]] || return 0

  local kdir="$top/kernel"

  # Only remove a real directory (not a symlink) to avoid surprises
  if [[ -d "$kdir" && ! -L "$kdir" ]]; then
    echo "[kernelpurge] Removing kernel directory: $kdir"
    rm -rf "$kdir"
  fi
}

repoclean_kernel_all() {
  [[ "$KERNEL_PURGE_BEFORE_SYNC" == "true" ]] || return 0
  [[ -n "${SRC_DIR:-}" && -d "${SRC_DIR:-}" ]] || return 0

  # Find each repo checkout (directory that contains .repo) under SRC_DIR
  while IFS= read -r -d '' repodir; do
    repoclean_kernel_top "$(dirname "$repodir")"
  done < <(find "$SRC_DIR" -maxdepth 3 -type d -name .repo -print0 2>/dev/null || true)
}
