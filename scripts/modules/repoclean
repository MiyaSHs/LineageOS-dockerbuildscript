#!/usr/bin/env bash
set -eo pipefail

# Minimal repoclean:
# - Finds each repo checkout under work/src/** (or SRC_DIR if set)
# - Deletes <repo_top>/kernel (so next repo sync re-fetches kernel cleanly)
#
# This fixes: "Cannot remove project: uncommitted changes are present" for kernel/*

repoclean() {
  local project_dir src_root
  project_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/../.." && pwd)"
  src_root="${SRC_DIR:-$project_dir/work/src}"

  [[ -d "$src_root" ]] || return 0

  # For each Android repo top (directory containing .repo), purge kernel/
  while IFS= read -r -d '' repodir; do
    local top kdir
    top="$(dirname "$repodir")"
    kdir="$top/kernel"

    # Safety: don't follow symlinks, don't touch /
    [[ "$top" != "/" ]] || continue
    if [[ -d "$kdir" && ! -L "$kdir" ]]; then
      echo "[repoclean] Removing: $kdir"
      rm -rf "$kdir"
    fi
  done < <(find "$src_root" -maxdepth 3 -type d -name .repo -print0 2>/dev/null || true)
}
