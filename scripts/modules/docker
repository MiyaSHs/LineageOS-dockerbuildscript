#!/usr/bin/env bash
set -eo pipefail

docker_run_lineage() {
  local with_gms="$1"   # true | false

  local image="${DOCKER_IMAGE:-lineageos4microg/docker-lineage-cicd:latest}"
  docker pull "$image" >/dev/null

  local extra_mounts=()
  if [[ -n "${CUSTOM_APPS_PAYLOAD_DIR:-}" && -d "${CUSTOM_APPS_PAYLOAD_DIR:-}" ]]; then
    extra_mounts+=( -v "$CUSTOM_APPS_PAYLOAD_DIR:/srv/custom_apps:ro" )
  fi

  docker run --rm -it \
    -e "BRANCH_NAME=$BRANCH_NAME" \
    -e "DEVICE_LIST=$DEVICE_LIST" \
    -e "WITH_GMS=$with_gms" \
    -e "SIGNATURE_SPOOFING=$SIGNATURE_SPOOFING" \
    -e "SIGN_BUILDS=$SIGN_BUILDS" \
    -e "CCACHE_SIZE=$CCACHE_SIZE" \
    -e "PARALLEL_JOBS=$PARALLEL_JOBS" \
    -e "ZIP_UP_IMAGES=$ZIP_UP_IMAGES" \
    -e "LOCAL_MIRROR=$LOCAL_MIRROR" \
    -e "ROOT_METHOD=$ROOT_METHOD" \
    -e "CUSTOM_PACKAGES=${CUSTOM_PACKAGES:-}" \
    -v "$SRC_DIR:/srv/src" \
    -v "$ZIPS_DIR:/srv/zips" \
    -v "$LOGS_DIR:/srv/logs" \
    -v "$CCACHE_DIR:/srv/ccache" \
    -v "$LOCAL_MANIFESTS_DIR:/srv/local_manifests" \
    -v "$USERSCRIPTS_DIR:/srv/userscripts" \
    -v "$KEYS_DIR:/srv/keys" \
    "${extra_mounts[@]}" \
    "$image"
}
