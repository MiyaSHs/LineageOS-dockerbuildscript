#!/usr/bin/env bash
set -eo pipefail

PROJECT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd)"

source "$PROJECT_DIR/scripts/bootstrap"
source "$PROJECT_DIR/scripts/modules/workdir"
source "$PROJECT_DIR/scripts/modules/manifests"
source "$PROJECT_DIR/scripts/modules/customapps"
source "$PROJECT_DIR/scripts/modules/userscripts"
source "$PROJECT_DIR/scripts/modules/docker"
source "$PROJECT_DIR/scripts/modules/repoclean"

check_deps
require_var DEVICE_LIST
require_var BRANCH_NAME
: "${ROOT_METHOD:=none}"

export_config
export ROOT_METHOD

workdir_init "microg"
local_manifests_clear
local_manifests_write_microg

repoclean_all

custom_apps_prepare
userscripts_write_before_sh

docker_run_lineage "true"
