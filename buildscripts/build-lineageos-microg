#!/usr/bin/env bash
set -euo pipefail

PROJECT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd)"
source "$PROJECT_DIR/scripts/bootstrap.sh"

: "${DEVICE_LIST:=}"
: "${BRANCH_NAME:=}"
: "${SIGNATURE_SPOOFING:=restricted}"
: "${SIGN_BUILDS:=true}"
: "${CCACHE_SIZE:=50G}"
: "${PARALLEL_JOBS:=8}"
: "${ROOT_METHOD:=none}"

WORKDIR="$PROJECT_DIR/work"
SRC_DIR="$WORKDIR/src"
CCACHE_DIR="$WORKDIR/ccache"
KEYS_DIR="$WORKDIR/keys"
LOCAL_MANIFESTS_DIR="$WORKDIR/local_manifests"
USERSCRIPTS_DIR="$WORKDIR/userscripts"
ZIPS_DIR="$WORKDIR/out/microg/zips"
LOGS_DIR="$WORKDIR/out/microg/logs"

mkdir -p \
  "$SRC_DIR" "$CCACHE_DIR" "$KEYS_DIR" \
  "$LOCAL_MANIFESTS_DIR" "$USERSCRIPTS_DIR" \
  "$ZIPS_DIR" "$LOGS_DIR"

# microG build requires vendor/partner_gms in local manifests
# The wiki example uses:
# path="vendor/partner_gms" name="lineageos4microg/android_vendor_partner_gms" remote="github" revision="master"
cat > "$LOCAL_MANIFESTS_DIR/00_microg.xml" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <remote name="github" fetch="https://github.com/" />
  <project
      path="vendor/partner_gms"
      name="lineageos4microg/android_vendor_partner_gms"
      remote="github"
      revision="master" />
</manifest>
EOF

# Reuse the exact same before.sh generator used in base script (root integration)
# (We simply call the base scriptâ€™s generator logic by reusing its file if present,
# but to keep it self-contained we regenerate it here.)
cat > "$USERSCRIPTS_DIR/before.sh" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

cd /srv/src

: "${ROOT_METHOD:=none}"
: "${DEVICE_LIST:=}"

if [[ "$ROOT_METHOD" == "none" ]]; then
  echo "[before.sh] ROOT_METHOD=none -> skipping root integration."
  exit 0
fi

if [[ "$DEVICE_LIST" == *","* || "$DEVICE_LIST" == *" "* ]]; then
  echo "[before.sh] Multiple devices in DEVICE_LIST='$DEVICE_LIST'. Root integration expects a single device build."
  exit 2
fi

DEFCONFIG_NAME="${DEVICE_LIST}_GKI.config"

KCONF="$(find . -path "*/arch/arm64/configs/vendor/${DEFCONFIG_NAME}" -print -quit || true)"
if [[ -z "$KCONF" ]]; then
  echo "[before.sh] Could not find ${DEFCONFIG_NAME}."
  exit 3
fi

KERNEL_DIR="$(realpath "$(dirname "$KCONF")/../../../..")"
DEFCONFIG_PATH="$(realpath "$KCONF")"

echo "[before.sh] Kernel dir: $KERNEL_DIR"
echo "[before.sh] Defconfig:  $DEFCONFIG_PATH"

cd "$KERNEL_DIR"
git reset --hard
git clean -fdx

ensure_kconfig() {
  local key="$1"
  local val="$2"
  local file="$3"
  if grep -qE "^${key}=" "$file"; then
    sed -i "s/^${key}=.*/${key}=${val}/" "$file"
  elif grep -qE "^# ${key} is not set" "$file"; then
    sed -i "s/^# ${key} is not set/${key}=${val}/" "$file"
  else
    echo "${key}=${val}" >> "$file"
  fi
}

ensure_not_set() {
  local key="$1"
  local file="$2"
  if grep -qE "^${key}=" "$file"; then
    sed -i "s/^${key}=.*/# ${key} is not set/" "$file"
  elif ! grep -qE "^# ${key} is not set" "$file"; then
    echo "# ${key} is not set" >> "$file"
  fi
}

case "$ROOT_METHOD" in
  kernelsu)
    curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
    ensure_kconfig CONFIG_KSU y "$DEFCONFIG_PATH"
    ensure_kconfig CONFIG_KPROBES y "$DEFCONFIG_PATH"
    ;;
  kernelsu-next)
    curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -
    ensure_kconfig CONFIG_KSU y "$DEFCONFIG_PATH"
    ensure_kconfig CONFIG_KPROBES y "$DEFCONFIG_PATH"
    ;;
  sukisu-ultra)
    curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
    ensure_kconfig CONFIG_KSU y "$DEFCONFIG_PATH"
    ensure_kconfig CONFIG_KPROBES y "$DEFCONFIG_PATH"
    ensure_not_set CONFIG_KSU_MANUAL_HOOK "$DEFCONFIG_PATH"
    ;;
  *)
    echo "[before.sh] Unknown ROOT_METHOD='$ROOT_METHOD'"
    exit 10
    ;;
esac
EOF

chmod +x "$USERSCRIPTS_DIR/before.sh"

docker pull lineageos4microg/docker-lineage-cicd:latest >/dev/null

docker run --rm -it \
  -e "BRANCH_NAME=$BRANCH_NAME" \
  -e "DEVICE_LIST=$DEVICE_LIST" \
  -e "WITH_GMS=true" \
  -e "SIGNATURE_SPOOFING=$SIGNATURE_SPOOFING" \
  -e "SIGN_BUILDS=$SIGN_BUILDS" \
  -e "CCACHE_SIZE=$CCACHE_SIZE" \
  -e "PARALLEL_JOBS=$PARALLEL_JOBS" \
  -e "ROOT_METHOD=$ROOT_METHOD" \
  -v "$SRC_DIR:/srv/src" \
  -v "$ZIPS_DIR:/srv/zips" \
  -v "$LOGS_DIR:/srv/logs" \
  -v "$CCACHE_DIR:/srv/ccache" \
  -v "$LOCAL_MANIFESTS_DIR:/srv/local_manifests" \
  -v "$USERSCRIPTS_DIR:/srv/userscripts" \
  -v "$KEYS_DIR:/srv/keys" \
  lineageos4microg/docker-lineage-cicd:latest
